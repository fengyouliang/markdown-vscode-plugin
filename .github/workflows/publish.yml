name: Publish VS Code Extension (Marketplace, main, opt-in)

on:
  push:
    branches:
      - "main"

concurrency:
  group: marketplace-publish-main
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  publish:
    if: ${{ vars.VSCE_PUBLISH_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    env:
      VSCE_PUBLISHER: ${{ vars.VSCE_PUBLISHER }}
      VSCE_PAT: ${{ secrets.VSCE_PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Validate publish variables
        run: |
          if [ -z "$VSCE_PUBLISHER" ]; then
            echo "Missing GitHub Actions variable: VSCE_PUBLISHER"
            exit 1
          fi
          if [ -z "$VSCE_PAT" ]; then
            echo "Missing GitHub Actions secret: VSCE_PAT"
            exit 1
          fi

      - name: Auto bump version (patch)
        run: |
          BASE_VERSION="$(node -p "require('./package.json').version")"
          MAJOR="$(node -p "require('./package.json').version.split('.')[0]")"
          MINOR="$(node -p "require('./package.json').version.split('.')[1]")"
          PATCH="$(git rev-list --count HEAD)"
          NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "Base version (package.json): ${BASE_VERSION}"
          echo "Auto version: ${NEXT_VERSION}"

          if ! [[ "${NEXT_VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid auto version: ${NEXT_VERSION}"
            exit 1
          fi

          # 仅在 CI 工作区同步 package.json 与 package-lock.json 的版本号（不回写提交）
          npm version "${NEXT_VERSION}" --no-git-tag-version

      - name: Sync publisher from repo variable
        run: npm pkg set publisher="${VSCE_PUBLISHER}"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run compile

      - name: Publish to VS Code Marketplace
        run: >
          npx @vscode/vsce publish
          --pat "${VSCE_PAT}"
          --readme-path "README.md"
          --changelog-path "helloagents/CHANGELOG.md"
          --allow-missing-repository
          --skip-license
          --skip-duplicate
